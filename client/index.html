<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  
  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  
  <link rel="import" href="bower_components/polymer/polymer.html">
  
  <link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
  <link rel="import" href="bower_components/iron-icons/iron-icons.html">
  <link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">
  
  <link rel="import" href="bower_components/paper-drawer-panel/paper-drawer-panel.html">
  <link rel="import" href="bower_components/paper-header-panel/paper-header-panel.html">
  <link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">
  <link rel="import" href="bower_components/paper-button/paper-button.html">
  <link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
  <link rel="import" href="bower_components/paper-menu/paper-menu.html">
  <link rel="import" href="bower_components/paper-item/paper-icon-item.html">
  
  <link rel="import" href="bower_components/neon-animation/neon-animated-pages.html">
  
  <link rel="import" href="bower_components/google-signin/google-signin.html">
  
  <link rel="import" href="elements/game-space/game-space.html">
  <link rel="import" href="elements/user-score/user-score.html">
  <link rel="import" href="elements/selection-dialog/selection-dialog.html">
  
  <link rel="import" href="helpers/array-shuffle/array-shuffle.html">
  
  <link rel="stylesheet" type="text/css" href="assets/css/fonts-sketchetik-light.css">
  
  <title></title>
  
  <style>
  body{
    margin: 0;
    height: 100vh;
  }
  </style>
</head>
<body>
  <dom-module id="page-element">
    <style>
    :root {
      --dark-primary-color: #303F9F;
      --default-primary-color:#3F51B5;
      --light-primary-color: #C5CAE9;
      --text-primary-color: #ffffff;
      --accent-color: #FF4081;
      
      --primary-background-color: #c5cae9;
      --primary-text-color: #212121;
      --secondary-text-color: #727272;
      --disabled-text-color: #bdbdbd;
      --divider-color: #B6B6B6;

      --drawer-menu-color: #ffffff;
      --drawer-border-color: 1px solid #ccc;
      --drawer-toolbar-border-color: 1px solid rgba(0, 0, 0, 0.22);
      
      --paper-menu-background-color: #ffffff;
      --menu-link-color: #111111;
    }
    :host,
    paper-button{
      font-family: SketchetikLight;
      font-weight: normal;
      font-style: normal;
    }
    paper-button{
      font-size: 6vh;
      line-height: 4vh;
      letter-spacing: 2px;
    }
    neon-animated-pages{
      @apply(--layout-fit);
    }
    paper-toolbar{
      padding: 0 8px;
    }
    paper-button::shadow .paper-button.keyboard-focus{
      font-weight: normal !important;
    }
    selection-dialog paper-button{
      width: 100%;
      font-size: 6.5vh;
      line-height: 3vh;
    }
    paper-button[noink]{
      background-image: url('assets/images/main-btn.png');
      background-size: 100% 200%;
      background-position: 0 0;
      color: #ffcc00;
    }
    paper-button[noink][pressed]{
      background-position: 0 -100%;
    }
    /*paper-button[noink][focused]{
      background-position: 0 -200%;
    }
    paper-button[noink][pressed][focused]{
      background-position: 0 -300%;
    }*/
    #home{
      background: url('assets/images/home-background.jpg');
      background-size: 100vw 100vh;
      @apply(--layout-vertical);
    }
    #home > paper-button{
      margin: 1.5vh 3vh;
    }
    #home > .padder{
      height: 1.5vh;
    }
    #ingame user-score{
      font-size: 3vh;
    }
    selection-dialog.large{
      @apply(--layout-fit);
    }
    selection-dialog.small{
      width: 100vw;
      height: 75vw;
    }
    selection-dialog.small paper-button{
      font-size: 4vh;
      line-height: 3vh;
    }
    #game-space{
      @apply(--layout-fit);
    }
    </style>
    <template>
      <neon-animated-pages selected="{{page}}" attr-for-selected="id" transitions="cross-fade-all">
        <section id="home">
          <div class="flex"></div>
          <paper-button raised noink on-tap="_btnPlayAction">Play</paper-button>
          <paper-button raised noink hidden$="[[signedin]]" on-tap="_btnSignInAction">Sign In</paper-button>
          <paper-button raised noink hidden$="[[!signedin]]" on-tap="_btnChallengeAction">Challenge</paper-button>
          <paper-button raised noink hidden$="[[!signedin]]" on-tap="_btnSignOutAction">Sign Out</paper-button>
          <div class="padder"></div>
          <selection-dialog id="difficulty-dialog" class="large">
            <h1>Select Difficulty</h1>
            <div></div>
            <paper-button raised noink data-difficulty="0" on-tap="_btnSetDifficultyAction">Easy</paper-button>
            <paper-button raised noink data-difficulty="1" on-tap="_btnSetDifficultyAction">Medium</paper-button>
            <paper-button raised noink data-difficulty="2" on-tap="_btnSetDifficultyAction">Hard</paper-button>
            <div></div>
          </selection-dialog>
          <selection-dialog id="signin-dialog" class="small">
            <h1>Sign In</h1>
            <google-signin
              id="google-signin"
              width="wide"
              height="tall"
              signed-in="{{signedin}}"
              client-id="666174339050-2n7h1on7neg4vvb011qluo29dq1hnnat.apps.googleusercontent.com"
              scopes="email"
              on-google-signin-success="_googleSignInAction"
              on-google-signed-out="_googleSignOutAction"></google-signin>
          </selection-dialog>
        </section>
        <section id="ingame">
          <paper-drawer-panel force-narrow disable-edge-swipe>
            <paper-header-panel drawer>
              <paper-toolbar justify="start">Menu</paper-toolbar>
              <paper-menu on-iron-select="_menuSelectAction">
                <paper-icon-item id="menu-item-new">
                  <iron-icon icon="icons:refresh" item-icon></iron-icon>New Level
                </paper-icon-item>
                <paper-icon-item id="menu-item-exit" class="new-section">
                  <iron-icon icon="cancel" item-icon></iron-icon>Exit
                </paper-icon-item>
              </paper-menu>
            </paper-header-panel>
            <paper-header-panel main>
              <paper-toolbar justify="center">
                <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
                <div class="flex"></div>
                <user-score score="{{score}}"></user-score>
              </paper-toolbar>
              <game-space id="game-space"
              url-data-path="[[dataPath]]"
              score="{{score}}"
              difficulty="{{difficulty}}"
              letter-tile-src="assets/images/tiles.png"
              tile-size="144"
              on-level-complete="_onLevelComplete"
              on-level-load-fail="_onLevelLoadFail"></game-space>
            </paper-header-panel>
          </paper-drawer-panel>
          <selection-dialog id="level-win-dialog" class="small">
            <h1>Well Done</h1>
            Continue to the next level?
            <paper-button raised noink on-tap="_btnNextLevelAction">Next Level</paper-button>
          </selection-dialog>
          <selection-dialog id="level-loading-error-dialog" class="small" no-close-btn>
            <h1>Error</h1>
            An error has occured while trying to load the level.
            <paper-button raised noink on-tap="_btnLevelLoadErrorOkAction">OK</paper-button>
          </selection-dialog>
        </section>
      </neon-animated-pages>
    </template>
  </dom-module>
  <script>
  window.addEventListener('WebComponentsReady', function(e) {
    Polymer({
      is: 'page-element',
      
      properties: {
        /**
         * The name of currently active page.
         */
        page: {
          type: String,
          value: 'home',
          observer: '_pageChangeEvent'
        },
        
        /**
         * The path to the json data.
         */
        dataPath: {
          type: String,
          value: 'http://still-waters-3351.herokuapp.com/play'
        },
        
        /**
         * Whether or not the user is signed in
         */
        signedin: Boolean
      },
      
      /**
       * Set the active page.
       * 
       * @param name The name of the page to switch to
       */
      _pageChangeEvent: function(newPage, oldPage){
        var $this = this;
        
        // wait until every else is done.
        setTimeout(function(){
          switch(newPage){
          case 'home':
            break;
            
          case 'ingame':
            // make sure the page is layed out right
            //$this.$['picture-space'].redraw();
            //$this.$['tile-space'].redraw();
            
            $this.$['game-space'].newLevel();
            break;
          }
        }, 0);
      },
      
      /**
       * Called on-tap of the play button.
       */
      _btnPlayAction: function(){
        this.$['difficulty-dialog'].open();
      },

      /**
       * Called on-tap of the challenge button.
       */
      _btnChallengeAction: function(){
        
      },

      /**
       * Called on-tap of the sign in button.
       */
      _btnSignInAction: function(){
        this.$['signin-dialog'].open();
      },

      /**
       * Called on-tap of the sign out button.
       */
      _btnSignOutAction: function(){
        this.signedin = false;
        this.$['google-signin'].signOut();
      },
      
      /**
       * Called upon sign in with google
       */
       _googleSignInAction: function(e){
        this.$['signin-dialog'].close();
      },
      
      /**
       * Called upon sign out of google
       */
      _googleSignOutAction: function(e){
        console.log(e)
        //todo
      },
      
      /**
       * Called on-tap of the difficulty selection buttons.
       */
      _btnSetDifficultyAction: function(e, detail){
        var btn = e.target.parentElement;
        
        // set difficulty before change to the game page
        this.difficulty = parseInt(btn.dataset.difficulty); // make sure the difficulty is a number, not a string
        this.$['difficulty-dialog'].close();                // close the dialog
        this.page = 'ingame';
      },
      
      /**
       * Called on-tap of the next level button.
       */
      _btnNextLevelAction: function(){
        this.$['level-win-dialog'].close();
        this.$['game-space'].newLevel();
      },
      
      /**
       * Called on-tap of the ok button in the level loading error dialog.
       */
      _btnLevelLoadErrorOkAction: function(){
        this.$['level-loading-error-dialog'].close();
        this.page = 'home';
      },
      
      /**
       * Called when an error occurs during a level load.
       */
      _onLevelLoadFail: function(){
        this.$['level-loading-error-dialog'].open();
      },
      
      /**
       * Called when a level is complete
       */
      _onLevelComplete: function(){
    	  this.$['level-win-dialog'].open();
      },

      /**
       * Called when a menu item is selected.
       */
      _menuSelectAction: function(e, detail){
        var id = detail.item.id;
        switch(id){
        case 'menu-item-new':
          this.$['game-space'].newLevel();
        break;
        
        case 'menu-item-exit':
          this.page = 'home';
          break;
        
        default:
          console.log('Menu item selected: ' + id);
          break;
        }
        
        Polymer.dom(e.target).querySelector('.iron-selected').blur(); // unfocuse the item
        e.target.selected = -1; // deselect the item
        Polymer.dom(this.$.ingame).querySelector('paper-drawer-panel').closeDrawer(); // close the drawer
      }
    });
  });
  </script>
  
  <page-element></page-element>
</body>
</html>