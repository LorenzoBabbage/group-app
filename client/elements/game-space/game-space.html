<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../picture-space/picture-space.html">
<link rel="import" href="../tile-space/tile-space.html">
<link rel="import" href="../picture-element/picture-element.html">
<link rel="import" href="../letter-tile/letter-tile.html">
<link rel="import" href="../user-level/user-level.html">
<link rel="import" href="../user-score/user-score.html">
  
<dom-module id="game-space">
  <style>
  :host{
    @apply(--layout-vertical);
  }
  #loading{
    background: rgba(0,0,0,0.25);
  }
  #titlebar{
    height: 48px;
  }
  .flex{
    @apply(--layout-flex);
    min-height: 8px;
  }
  picture-space{
    height: 50%;
  }
  tile-space{
    height: calc(50% - 64px);
    max-height: 250px;
  }
  picture-space letter-tile{
    width: 32px;
    margin: 1px;
  }
  tile-space letter-tile{
    width: 64px;
    height: 64px;
    margin: 4px;
  }
  letter-tile{
    width: 64px;
    z-index: 101;
  }
  user-score{
    font-size: 3.5vh;
    position: absolute;
    top: 0;
    right: 0;
    font-family: "Arial Black", Gadget, sans-serif;
  }
  #loading{
    @apply(--layout-horizontal);
    @apply(--layout-center-justified);
    @apply(--layout-center);
    @apply(--layout-fit);
    font-size: 6vh;
  }
  </style>
  <template>
    <iron-ajax
      id="ajax"
      handle-as="json"
      url="[[urlDataPath]]"
      params='[[_getAjaxParams(difficulty)]]'
      method="GET"
      last-response="{{ajaxResponse}}"
      on-response="_ajaxSuccessHandler"
      on-error="_ajaxErrorHandler"></iron-ajax>
    <div id="titlebar">
      <content></content>
      <user-score score="[[score]]"></user-score>
      <!-- <user-level level="[[difficulty]]"></user-level> -->
    </div>
    <div class="flex"></div>
    <picture-space id="picture-space" loading="[[loading]]">
      <template is="dom-repeat" items="[[ajaxResponse.data]]">
        <picture-element word="{{item.word}}" picture-space="[[_pictureSpace]]" on-add-tile="_pictureElementOnAddTile" on-remove-tile="_pictureElementOnRemoveTile" class="letter-tile-drop-zone">
          <img src="{{item.img}}">
        </picture-element>
      </template>
    </picture-space>
    <div class="flex"></div>
    <tile-space loading="[[loading]]" class="letter-tile-drop-zone redisplay-letter-tiles">
      <template is="dom-repeat" items=[[_getAllLetters(ajaxResponse.data)]]">
        <letter-tile src="[[letterTileSrc]]" letter="[[item]]" index="[[index]]" drag-container="[[_gameSpace]]"></letter-tile>
      </template>
    </tile-space>
    <div id="loading" hidden$="[[!loading]]">Loading...</div>
  </template>
</dom-module>

<script>
Polymer({
  is: 'game-space',
  
  properties: {
    /**
     * The difficulty the user is on
     * 0 - Easy
     * 1 - Medium
     * 2 - Hard
     */
    difficulty: {
      type: Number,
      value: 0,
      notify: true
    },
    
    /**
     * The user's score.
     */
    score: {
      type: Number,
      value: 0,
      notify: true
    },
    
    /**
     * True if the game is waiting for images from the server
     */
    loading:{
      type: Boolean,
      value: false,
      notify: true
    },
    
    /**
     * The path to the server to get the image json data
     */
    urlDataPath: String,
    
    /**
     * the path to the tile images
     */
    tilePath: String,
    
    /**
     * The picture-space.
     * Used to give picture-elements their parent.
     */
    _pictureSpace: {
      type: Object,
      value: function(){
        return this.$['picture-space'];
      },
      readOnly: true
    },
    
    /**
     * This
     * Used to give letter-tiles their ghost parent.
     */
    _gameSpace: {
      type: Object,
      value: function(){
        return this;
      },
      readOnly: true
    }
  },
  
  /**
   * Start a new Level
   */
  newLevel: function(){
    this.loading = true;
    // clear the old ajaxResponse object - so that the arn't tiles hanging around for the last level
    if(this.ajaxResponse){
      this.ajaxResponse = { data: [] };
    }
    this.$.ajax.generateRequest();
    this.$['picture-space'].reset();
  },

  /**
   * Get the characters in the given string as an array.
   * 
   * @return array
   */
  _getLetters: function(str){
    return str.toLowerCase().split('');
  },
  
  /**
   * Get all the letter in the words in the given collection.
   */
  _getAllLetters: function(data){
    var letters = [];
    
    if(data){
      // foreach word
      for(var i=0; i<data.length; i++){
        var letterArray = this._getLetters(data[i].word);  // split it into an array of characters
        // for each letter
        for(var j=0; j<letterArray.length; j++){
          letters.push(letterArray[j]);  // add it to the array of letters
        }
      }
  
      letters.shuffle(); // shuffle the letters
    }
    
    return letters;
  },
  
  /**
   * Handeler for when the ajax request succeed
   */
  _ajaxSuccessHandler: function (event, detail, sender) {
    if(detail.xhr.status === 0){
      this._ajaxErrorHandler(event, detail, sender);
    }
    else{
      this.loading = false;
      this.fire('level-load-success');
    }
  },
  
  /**
   * Handeler for when the ajax request fails
   */
  _ajaxErrorHandler: function (event, detail, sender) {
    this.loading = false;
    this.fire('level-load-fail');
  },
  
  /**
   * Get the params to send to the server
   */
  _getAjaxParams: function(difficulty_level){
    return {
      difficulty: difficulty_level
    };
  },
  
  _getPictureElements: function(){
	  return this.querySelectorAll('picture-element');
  },
  
  /**
   * Called when a tile is added to a picture element
   */
  _pictureElementOnAddTile: function(event, detail){
	  var allCorrect = true;
	  
	  var pes = this._getPictureElements();
	  for(var i=0; i<pes.length; i++){
		  if(!pes[i].isCorrect()){
			  allCorrect = false;
			  break;
		  }
	  };
	  
	  if(allCorrect){
		  this.fire('level-complete');
	  }
  },
  
  /**
   * Called when a tile is removed to a picture element
   */
  _pictureElementOnRemoveTile: function(event, detail){
    console.log('removed letter: ' + detail.letter);
  }
});
</script>
