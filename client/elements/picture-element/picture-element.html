<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<dom-module id="picture-element">
	<style>
	:host{
	  position: relative;
	  display: block;
	  box-sizing: border-box;
	  background: orange;
	  border: solid #000000 1px;
	  border-radius: 4px;
	  height: 100%;
	  max-width: 100vw;
	  -ms-transform-origin: 50% 0;
	  -webkit-transform-origin: 50% 0;
	  transform-origin: 50% 0;
	}
	:host:after {
	  padding-left: 75%;
	  display: block;
	  content: '';
	}
	:host #image-wrapper{
	  width: calc(100% - 16px);
	  position: relative;
	  box-sizing: border-box;
	  border: solid 1px #000000;
	  border-radius: 2px;
	  margin: 8px;
	  overflow: hidden;
	  background: #000000;
	}
	:host #image-wrapper:before{
	  padding-top: 100%;
	  display: block;
	  content: '';
	}
	:host #word-zone{
	  margin: 8px 8px 5px 8px;
	  border-bottom: dashed 3px #000000;
	  box-sizing: border-box;
    @apply(--layout-horizontal);
    @apply(--layout-end);
    @apply(--layout-center-center);
	}
	:host ::content img{
	  position: absolute !important;
	  top: 0;
	  left: 0;
	  width: auto;
	  height: auto;
	}
	</style>
  <template>
    <div id="image-wrapper">
      <content id="image" select="img"></content>
    </div>
    <div id="word-zone">
      <content id="tiles" select="letter-tile"></content>
    </div>
  </template>
</dom-module>

<script>
Polymer({
	is: 'picture-element',
	
	properties: {
	  /**
	   * The picture-space (parent) of this element
	   */
		pictureSpace: Object,
		
		/**
		 * The word for this picture
		 */
	  word: String
	},

  ready: function(){
    var $this = this;
    window.addEventListener('resize', function(){
      $this.maintainAspectRatio();
    });
  },
  
  attached: function(){
	  this.maintainAspectRatio();
	  this.pictureSpace.layoutPictureElements();
  },
  
  /**
   * Resize the element to the correct aspect ratio.
   *
   * This method is needed as there is no way (as far as I now)
   * to inforce an aspect ratio based on a set height using css.
   */
  maintainAspectRatio: function(){
    var ratio =  1 / 1.2;
    
    Polymer.dom.flush();
    
    // set width of this element
    this.style.width = (Polymer.dom(this).node.clientHeight * ratio) + 'px';
    
    // set the height of #word-zone
    this.$['word-zone'].style.height = (Polymer.dom(this).node.clientHeight - Polymer.dom(this.$['image-wrapper']).node.offsetHeight - 8 * 3 + parseInt(getComputedStyle(Polymer.dom(this.$['word-zone']).node, null).getPropertyValue('border-bottom-width'))) + 'px';
    
    
    var tiles = this._getLetterTiles();
    
    // resize the tiles
    tiles.forEach(function(element, index, array){
      element.style.width = Polymer.dom(this.$['word-zone']).node.clientHeight + 'px';
    }, this);
    
    // update the font-size of the tiles.
    // this is done after the tile resize as the flex container of the tiles may
    // further change their size
    tiles.forEach(function(element, index, array){
      element.updateFontSize();
    }, this);
    
    
    var image = this._getImage();

    // resize the image
    image.style.height = Polymer.dom(this.$['image-wrapper']).node.clientHeight + 'px';
    image.style.width = Polymer.dom(this.$['image-wrapper']).node.clientWidth + 'px';
  },
  
  /**
   * Get the distributed letter-tile children of this element.
   */
  _getLetterTiles: function(){
    return Polymer.dom(this.$.tiles).getDistributedNodes();
  },

  /**
   * Get image distributed in this element. (Assumes only one)
   */
  _getImage: function(){
    return Polymer.dom(this.$.image).getDistributedNodes()[0];
  },
  
  /**
   * Add the given tile to this element
   */
  addTile: function(tile, x, y){
    if(this.pictureSpace.getSelectedPictureElement() != this){
      return false;
    }
    Polymer.dom(this).appendChild(tile);
    tile.updateFontSize();
    
    var $this = this;
    setTimeout(function(){
	    $this.fire('add-tile', {
	    	letter: tile.letter
	    });
    }, 0);
    return true;
  },
  
  /**
   * Remove the given tile from this element
   */
  removeTile: function(tile){
    // FIXME - uses _lightParent
	  if(this != tile._lightParent){
		  return false;
	  }
	  
	  Polymer.dom(tile._lightParent).removeChild(tile);
    
	  var $this = this;
	  setTimeout(function(){
	    $this.fire('remove-tile', {
	      letter: tile.letter
	    });
	  }, 0);
    return true;
  },
  
  /**
   * Return whether or not the tiles in this element spell the correct word.
   */
  isCorrect: function(){
	  return this._getUserWord() == this.word;
  },
  
  _getUserWord: function(){
	  var word = '';
	  var letters = this._getLetterTiles();
	  letters.forEach(function(element, index, array){
		  word += element.letter;
	  });
	  return word;
  }
});
</script>